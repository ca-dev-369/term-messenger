<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TERM — Messenger</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- ═══════════════════════════
     AUTH SCREEN
═══════════════════════════ -->

<div id="screen-auth" class="screen active">
  <div class="auth-wrap">
    <header class="auth-header">
      <div class="logo">TERM</div>
      <div class="logo-sub">// INTERNAL MESSENGER</div>
    </header>

```
<!-- LOGIN -->
<div class="auth-panel active" id="panel-login">
  <div class="panel-label">INICIAR SESIÓN</div>
  <div class="field-group">
    <label class="field-label">EMAIL</label>
    <input id="login-email" type="email" class="field-input" placeholder="tu@email.com" autocomplete="email" />
  </div>
  <div class="field-group">
    <label class="field-label">CONTRASEÑA</label>
    <input id="login-pass" type="password" class="field-input" placeholder="••••••••" />
  </div>
  <div class="auth-actions">
    <button class="btn-primary" id="btn-login">CONECTAR</button>
    <button class="btn-ghost" id="goto-register">Sin cuenta → Registrarse</button>
  </div>
  <div class="auth-error hidden" id="login-error"></div>
</div>

<!-- REGISTER -->
<div class="auth-panel" id="panel-register">
  <div class="panel-label">CREAR CUENTA</div>
  <div class="field-group">
    <label class="field-label">NOMBRE</label>
    <input id="reg-name" type="text" class="field-input" placeholder="Tu Nombre" maxlength="32" />
  </div>
  <div class="field-group">
    <label class="field-label">EMAIL</label>
    <input id="reg-email" type="email" class="field-input" placeholder="tu@email.com" />
  </div>
  <div class="field-group">
    <label class="field-label">CONTRASEÑA</label>
    <input id="reg-pass" type="password" class="field-input" placeholder="mín. 6 caracteres" />
  </div>
  <div class="field-group">
    <label class="field-label">AVATAR</label>
    <div class="avatar-grid" id="avatar-grid">
      <button class="av-btn active" data-av="[ ]">[ ]</button>
      <button class="av-btn" data-av="[+]">[+]</button>
      <button class="av-btn" data-av="[~]">[~]</button>
      <button class="av-btn" data-av="[#]">[#]</button>
      <button class="av-btn" data-av="[$]">[$]</button>
      <button class="av-btn" data-av="[*]">[*]</button>
      <button class="av-btn" data-av="[!]">[!]</button>
      <button class="av-btn" data-av="[?]">[?]</button>
    </div>
  </div>
  <div class="auth-actions">
    <button class="btn-primary" id="btn-register">CREAR</button>
    <button class="btn-ghost" id="goto-login">Ya tengo cuenta → Entrar</button>
  </div>
  <div class="auth-error hidden" id="reg-error"></div>
</div>

<div class="auth-loader hidden" id="auth-loader">
  <span class="blink-cursor">█</span> conectando...
</div>

<footer class="auth-footer">
  <span class="blink-cursor">█</span> CIFRADO · TIEMPO REAL · USO INTERNO
</footer>
```

  </div>
</div>

<!-- ═══════════════════════════
     CHAT SCREEN
═══════════════════════════ -->

<div id="screen-chat" class="screen">

  <!-- SIDEBAR -->

  <nav id="sidebar">
    <div class="sb-top">
      <div class="brand">TERM</div>
      <button class="icon-btn" id="btn-logout" title="Salir">⏻</button>
    </div>

```
<div class="sb-user" id="sb-user">
  <div class="sb-av" id="sb-av">[ ]</div>
  <div class="sb-info">
    <div class="sb-name" id="sb-name">—</div>
    <div class="sb-email" id="sb-email">—</div>
  </div>
  <div class="online-dot"></div>
</div>

<div class="sb-section">
  <div class="sb-label">CANALES</div>
  <ul class="sb-list" id="channel-list">
    <li class="sb-item active" data-ch="general">
      <span class="ch-hash">#</span><span>general</span>
      <span class="ch-badge hidden">0</span>
    </li>
    <li class="sb-item" data-ch="archivos">
      <span class="ch-hash">#</span><span>archivos</span>
      <span class="ch-badge hidden">0</span>
    </li>
    <li class="sb-item" data-ch="ops">
      <span class="ch-hash">#</span><span>ops</span>
      <span class="ch-badge hidden">0</span>
    </li>
  </ul>
  <button class="sb-add" id="btn-add-ch">+ canal</button>
</div>

<div class="sb-section">
  <div class="sb-label">EN LÍNEA</div>
  <ul class="sb-list" id="online-list"></ul>
</div>

<div class="sb-footer">
  <div class="sb-stat"><span class="sk">ESTADO</span><span class="sv" id="stat-conn">—</span></div>
  <div class="sb-stat"><span class="sk">CANAL</span><span class="sv" id="stat-ch">general</span></div>
</div>
```

  </nav>

  <!-- MAIN -->

  <main id="main">
    <div id="topbar">
      <button class="icon-btn mobile-only" id="btn-menu">≡</button>
      <div class="tb-left">
        <span class="tb-hash">#</span>
        <span id="tb-name">general</span>
        <span class="tb-sep">—</span>
        <span class="tb-desc" id="tb-desc">chat general</span>
      </div>
      <div class="tb-right">
        <button class="icon-btn" id="btn-search">⌕</button>
        <button class="icon-btn" id="btn-help">/</button>
      </div>
    </div>

```
<!-- SEARCH -->
<div id="searchbar" class="hidden">
  <span class="s-prompt">buscar ›</span>
  <input id="search-inp" type="text" placeholder="filtrar mensajes..." />
  <button class="icon-btn" id="btn-s-close">✕</button>
</div>

<!-- MESSAGES -->
<div id="messages" role="log"></div>

<!-- TYPING -->
<div id="typing-row" class="hidden">
  <div class="t-dots"><span></span><span></span><span></span></div>
  <span id="typing-who">escribiendo...</span>
</div>

<!-- COMPOSER -->
<div id="composer">
  <div id="att-preview" class="hidden"></div>
  <div id="composer-row">
    <div class="c-prompt" id="c-prompt">› </div>
    <textarea id="msg-inp" rows="1" placeholder="escribe un mensaje..."></textarea>
    <div class="c-tools">
      <button class="tool-btn" id="btn-img">img</button>
      <button class="tool-btn" id="btn-file">archivo</button>
      <button class="send-btn" id="btn-send">↵</button>
    </div>
  </div>
  <div class="c-hint"><kbd>Enter</kbd> enviar · <kbd>Shift+Enter</kbd> nueva línea · <kbd>/help</kbd> comandos</div>
</div>

<input type="file" id="inp-img" accept="image/*" hidden />
<input type="file" id="inp-file" hidden />
```

  </main>

  <!-- COMMANDS -->

  <div id="overlay-cmds" class="overlay hidden">
    <div class="overlay-box">
      <div class="ov-title">// COMANDOS</div>
      <table class="cmd-table">
        <tr><td class="ck">/help</td><td class="cv">mostrar comandos</td></tr>
        <tr><td class="ck">/nick &lt;n&gt;</td><td class="cv">cambiar nombre</td></tr>
        <tr><td class="ck">/me &lt;texto&gt;</td><td class="cv">mensaje de acción</td></tr>
        <tr><td class="ck">/clear</td><td class="cv">limpiar vista local</td></tr>
        <tr><td class="ck">/shrug</td><td class="cv">¯\_(ツ)_/¯</td></tr>
        <tr><td class="ck">/flip</td><td class="cv">(╯°□°）╯︵ ┻━┻</td></tr>
        <tr><td class="ck">/whoami</td><td class="cv">info de sesión</td></tr>
      </table>
      <button class="btn-ghost" id="btn-close-cmds">[ cerrar ]</button>
    </div>
  </div>

  <!-- LIGHTBOX -->

  <div id="lightbox" class="hidden">
    <div id="lb-bg"></div>
    <div id="lb-inner">
      <button id="lb-close">✕</button>
      <img id="lb-img" src="" alt="" />
      <div id="lb-meta"></div>
    </div>
  </div>
</div>

<!-- TOAST -->

<div id="toast" class="hidden"></div>

<!-- ═══════════════════════════
     FIREBASE (CDN — sin npm)
═══════════════════════════ -->

<script type="module">
  import { initializeApp }                          from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword,
           signInWithEmailAndPassword, signOut,
           onAuthStateChanged, updateProfile }      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc,
           query, orderBy, onSnapshot, serverTimestamp,
           doc, setDoc, getDoc, getDocs,
           where, limit }                           from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  // ── CONFIG ──────────────────────────────
  const firebaseConfig = {
    apiKey:            "AIzaSyCsnaUlAym1xBy0QnlBehRvm1o8cthOVoI",
    authDomain:        "terminalmessenger-6040b.firebaseapp.com",
    projectId:         "terminalmessenger-6040b",
    storageBucket:     "terminalmessenger-6040b.firebasestorage.app",
    messagingSenderId: "932577335300",
    appId:             "1:932577335300:web:cb0e53f8ee72f323e4bd51",
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  // Storage no requerido — archivos se guardan como base64 en Firestore

  // ── STATE ────────────────────────────────
  let currentUser   = null;
  let currentAvatar = '[ ]';
  let activeChannel = 'general';
  let unsubMessages = null;
  let unsubOnline   = null;
  let pendingFiles  = [];
  let typingTimer   = null;
  let sessionStart  = Date.now();

  const CHANNELS = {
    general:  'chat general · todos',
    archivos: 'compartir archivos · transferencias',
    ops:      'operaciones · uso interno',
  };

  // ── UTILS ────────────────────────────────
  const $  = id => document.getElementById(id);
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const fmt = text => {
    let s = esc(text);
    s = s.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

```
s = s.replace(/`([^`\n]+)`/g, '<code>$1</code>');
s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
s = s.replace(/_([^_\n]+)_/g, '<em>$1</em>');
s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
return s;
```

};

const ftime = ts => {
if (!ts) return ‘’;
const d = ts.toDate ? ts.toDate() : new Date(ts);
return d.toLocaleTimeString([], { hour: ‘2-digit’, minute: ‘2-digit’ });
};

const fdate = ts => {
if (!ts) return ‘’;
const d = ts.toDate ? ts.toDate() : new Date(ts);
const t = new Date();
const y = new Date(t); y.setDate(y.getDate() - 1);
if (d.toDateString() === t.toDateString()) return ‘HOY’;
if (d.toDateString() === y.toDateString()) return ‘AYER’;
return d.toLocaleDateString(‘es’, { weekday: ‘short’, month: ‘short’, day: ‘numeric’ }).toUpperCase();
};

const fsize = b => {
if (b < 1024) return b + ’ B’;
if (b < 1048576) return (b/1024).toFixed(1) + ’ KB’;
return (b/1048576).toFixed(2) + ’ MB’;
};

const fileTag = name => {
const ext = (name.split(’.’).pop() || ‘’).toLowerCase();
const m = { pdf:‘PDF’,doc:‘DOC’,docx:‘DOC’,txt:‘TXT’,md:‘MD’,
xls:‘XLS’,xlsx:‘XLS’,csv:‘CSV’,zip:‘ZIP’,rar:‘ZIP’,
mp3:‘MP3’,wav:‘WAV’,mp4:‘MP4’,mov:‘MOV’,
js:‘JS’,ts:‘TS’,py:‘PY’,html:‘HTM’,css:‘CSS’,json:‘JSON’ };
return m[ext] || ‘FILE’;
};

let toastTimer;
const toast = (msg, ms = 3000) => {
const el = $(‘toast’);
el.textContent = msg;
el.classList.remove(‘hidden’);
clearTimeout(toastTimer);
toastTimer = setTimeout(() => el.classList.add(‘hidden’), ms);
};

// ── AUTH ─────────────────────────────────
onAuthStateChanged(auth, async user => {
if (user) {
// Load avatar from Firestore
const snap = await getDoc(doc(db, ‘users’, user.uid));
const data = snap.exists() ? snap.data() : {};
currentUser = { uid: user.uid, name: user.displayName || ‘Usuario’, email: user.email, avatar: data.avatar || ‘[ ]’ };
bootChat();
} else {
currentUser = null;
showAuth();
}
});

async function doRegister() {
const name  = $(‘reg-name’).value.trim();
const email = $(‘reg-email’).value.trim();
const pass  = $(‘reg-pass’).value;
const errEl = $(‘reg-error’);
errEl.classList.add(‘hidden’);

```
if (!name)         { showErr(errEl, 'Ingresa tu nombre'); return; }
if (!email)        { showErr(errEl, 'Ingresa tu email'); return; }
if (pass.length < 6) { showErr(errEl, 'Contraseña mínimo 6 caracteres'); return; }

setLoading(true);
try {
  const cred = await createUserWithEmailAndPassword(auth, email, pass);
  await updateProfile(cred.user, { displayName: name });
  await setDoc(doc(db, 'users', cred.user.uid), {
    name, email, avatar: currentAvatar, createdAt: serverTimestamp()
  });
} catch (e) {
  setLoading(false);
  showErr(errEl, firebaseError(e.code));
}
```

}

async function doLogin() {
const email = $(‘login-email’).value.trim();
const pass  = $(‘login-pass’).value;
const errEl = $(‘login-error’);
errEl.classList.add(‘hidden’);

```
if (!email || !pass) { showErr(errEl, 'Completa todos los campos'); return; }

setLoading(true);
try {
  await signInWithEmailAndPassword(auth, email, pass);
} catch (e) {
  setLoading(false);
  showErr(errEl, firebaseError(e.code));
}
```

}

async function doLogout() {
await setUserOnline(false);
await signOut(auth);
}

const showErr = (el, msg) => { el.textContent = msg; el.classList.remove(‘hidden’); };
const setLoading = on => { $(‘auth-loader’).classList.toggle(‘hidden’, !on); };

const firebaseError = code => ({
‘auth/email-already-in-use’: ‘Este email ya está registrado’,
‘auth/invalid-email’:        ‘Email inválido’,
‘auth/weak-password’:        ‘Contraseña muy débil’,
‘auth/user-not-found’:       ‘Usuario no encontrado’,
‘auth/wrong-password’:       ‘Contraseña incorrecta’,
‘auth/invalid-credential’:   ‘Email o contraseña incorrectos’,
‘auth/network-request-failed’: ‘Sin conexión a internet’,
}[code] || ’Error: ’ + code);

// ── PRESENCE (online users) ───────────────
async function setUserOnline(online) {
if (!currentUser) return;
await setDoc(doc(db, ‘presence’, currentUser.uid), {
name: currentUser.name,
avatar: currentUser.avatar,
online,
lastSeen: serverTimestamp(),
}, { merge: true });
}

function listenOnline() {
if (unsubOnline) unsubOnline();
const q = query(collection(db, ‘presence’), where(‘online’, ‘==’, true));
unsubOnline = onSnapshot(q, snap => {
const list = $(‘online-list’);
list.innerHTML = ‘’;
snap.forEach(d => {
const u = d.data();
const li = document.createElement(‘li’);
li.className = ‘sb-item ol-item’;
li.innerHTML = `<span class="ch-hash">${esc(u.avatar||'[ ]')}</span><span>${esc(u.name)}</span>`;
list.appendChild(li);
});
});
}

// ── BOOT CHAT ────────────────────────────
async function bootChat() {
$(‘screen-auth’).classList.remove(‘active’);
$(‘screen-chat’).classList.add(‘active’);
setLoading(false);

```
$('sb-av').textContent    = currentUser.avatar;
$('sb-name').textContent  = currentUser.name;
$('sb-email').textContent = currentUser.email;
$('stat-conn').textContent = 'EN LÍNEA';

await setUserOnline(true);
listenOnline();
switchChannel('general');

// Keepalive
setInterval(() => setUserOnline(true), 60000);

// Window unload
window.addEventListener('beforeunload', () => setUserOnline(false));
```

}

function showAuth() {
$(‘screen-chat’).classList.remove(‘active’);
$(‘screen-auth’).classList.add(‘active’);
$(‘login-email’).focus();
}

// ── CHANNELS ─────────────────────────────
function switchChannel(ch) {
activeChannel = ch;

```
document.querySelectorAll('.sb-item[data-ch]').forEach(el => {
  el.classList.toggle('active', el.dataset.ch === ch);
  if (el.dataset.ch === ch) el.querySelector('.ch-badge')?.classList.add('hidden');
});

$('tb-name').textContent  = ch;
$('tb-desc').textContent  = CHANNELS[ch] || 'canal personalizado';
$('stat-ch').textContent  = ch;
$('c-prompt').textContent = `@${currentUser.name.split(' ')[0].toLowerCase()} › `;

$('messages').innerHTML = '';
listenMessages(ch);
$('sidebar').classList.remove('open');
```

}

function addChannel(name) {
const clean = name.toLowerCase().replace(/[^a-z0-9-_]/g,’’).slice(0,20);
if (!clean || clean.length < 2) { toast(‘Nombre de canal inválido’); return; }

```
CHANNELS[clean] = `canal personalizado · #${clean}`;

const li = document.createElement('li');
li.className = 'sb-item';
li.dataset.ch = clean;
li.innerHTML = `<span class="ch-hash">#</span><span>${clean}</span><span class="ch-badge hidden">0</span>`;
li.addEventListener('click', () => switchChannel(clean));
$('channel-list').appendChild(li);
switchChannel(clean);
```

}

// ── MESSAGES (REAL-TIME) ──────────────────
function listenMessages(channel) {
if (unsubMessages) unsubMessages();

```
const q = query(
  collection(db, 'channels', channel, 'messages'),
  orderBy('ts', 'asc'),
  limit(200)
);

let lastDate = null;
let initialized = false;

unsubMessages = onSnapshot(q, snap => {
  snap.docChanges().forEach(change => {
    if (change.type === 'added') {
      const msg = { id: change.doc.id, ...change.doc.data() };

      // Day separator
      const d = fdate(msg.ts);
      if (d !== lastDate) {
        const sep = document.createElement('div');
        sep.className = 'day-sep';
        sep.textContent = d;
        $('messages').appendChild(sep);
        lastDate = d;
      }

      appendMsg(msg, initialized);
    }
  });

  if (!initialized) {
    initialized = true;
    scrollBottom();
  }
});
```

}

function appendMsg(msg, animate = true) {
const el = buildMsgEl(msg);
if (animate) el.style.animation = ‘msg-in 0.18s cubic-bezier(0.16,1,0.3,1) both’;
$(‘messages’).appendChild(el);
if (animate) scrollBottom();
}

function buildMsgEl(msg) {
const div = document.createElement(‘div’);
const isOwn = msg.authorId === currentUser.uid;

```
if (msg.type === 'sys') {
  div.className = 'msg sys';
  div.innerHTML = `<div class="msg-av">·</div><div class="msg-body"><div class="msg-text">${esc(msg.content)}</div></div>`;
  return div;
}

div.className = `msg${isOwn ? ' own' : ''}${msg.type === 'action' ? ' action' : ''}`;
div.dataset.id = msg.id;

const av = document.createElement('div');
av.className = 'msg-av';
av.textContent = msg.authorAvatar || '[ ]';

const body = document.createElement('div');
body.className = 'msg-body';

const meta = document.createElement('div');
meta.className = 'msg-meta';
meta.innerHTML = `<span class="msg-name">${esc(msg.authorName || 'Usuario')}</span><span class="msg-time">${ftime(msg.ts)}</span>`;

const txt = document.createElement('div');
txt.className = 'msg-text';
if (msg.content) txt.innerHTML = fmt(msg.content);

// Image attachment
if (msg.imageUrl) {
  const img = document.createElement('img');
  img.className = 'msg-img';
  img.src = msg.imageUrl;
  img.alt = msg.imageName || 'imagen';
  img.loading = 'lazy';
  img.addEventListener('click', () => openLightbox(msg.imageUrl, msg.imageName || 'imagen'));
  txt.appendChild(img);
}

// File attachment (base64)
if (msg.fileData) {
  const file = document.createElement('div');
  file.className = 'msg-file';
  file.innerHTML = `
    <span class="mf-tag">${fileTag(msg.fileName || '')}</span>
    <span class="mf-info">
      <span class="mf-name">${esc(msg.fileName || 'archivo')}</span>
      <span class="mf-size">${msg.fileSize || ''}</span>
    </span>
    <span class="mf-dl">↓</span>
  `;
  file.addEventListener('click', () => {
    const a = document.createElement('a');
    a.href = msg.fileData;
    a.download = msg.fileName || 'archivo';
    a.click();
  });
  txt.appendChild(file);
}

// Reaction / copy tools
const tools = document.createElement('div');
tools.className = 'msg-tools';
tools.innerHTML = `<button class="msg-tool" data-a="copy">copiar</button>`;
tools.querySelector('[data-a="copy"]').addEventListener('click', () => {
  navigator.clipboard.writeText(msg.content || '').then(() => toast('Copiado'));
});

body.appendChild(meta);
body.appendChild(txt);
div.appendChild(av);
div.appendChild(body);
div.appendChild(tools);
return div;
```

}

function scrollBottom() {
const el = $(‘messages’);
el.scrollTop = el.scrollHeight;
}

// ── SEND ─────────────────────────────────
async function send() {
const input = $(‘msg-inp’);
const text  = input.value.trim();

```
if (!text && pendingFiles.length === 0) return;

if (text.startsWith('/')) {
  input.value = '';
  resizeInput();
  handleCommand(text);
  return;
}

const base = {
  authorId:     currentUser.uid,
  authorName:   currentUser.name,
  authorAvatar: currentUser.avatar,
  ts:           serverTimestamp(),
  type:         'text',
  content:      text,
};

input.value = '';
resizeInput();

// Archivos como base64 directo en Firestore (sin Storage)
if (pendingFiles.length > 0) {
  for (const pf of pendingFiles) {
    const msgData = { ...base, content: text };
    try {
      // Comprimir imagen si es muy grande
      let data64 = pf.data;
      if (pf.type === 'image' && pf.file.size > 200 * 1024) {
        data64 = await compressImage(pf.file, 800, 0.7);
      }
      if (pf.type === 'image') {
        msgData.imageUrl  = data64;
        msgData.imageName = pf.file.name;
      } else {
        msgData.fileData  = data64;
        msgData.fileName  = pf.file.name;
        msgData.fileSize  = fsize(pf.file.size);
        msgData.fileMime  = pf.file.type;
      }
    } catch (e) {
      toast('Error procesando archivo: ' + e.message);
      continue;
    }
    await addDoc(collection(db, 'channels', activeChannel, 'messages'), msgData);
    base.content = '';
  }
  clearPending();
} else {
  await addDoc(collection(db, 'channels', activeChannel, 'messages'), base);
}
```

}

// ── COMMANDS ─────────────────────────────
function handleCommand(raw) {
const parts = raw.slice(1).split(’ ‘);
const cmd   = parts[0].toLowerCase();
const args  = parts.slice(1).join(’ ’).trim();

```
const sysPost = content => addDoc(collection(db, 'channels', activeChannel, 'messages'), {
  type: 'sys', content,
  authorId: currentUser.uid,
  ts: serverTimestamp(),
});

switch (cmd) {
  case 'help':
    $('overlay-cmds').classList.remove('hidden');
    break;
  case 'clear':
    $('messages').innerHTML = '';
    toast('Vista local limpiada (mensajes en servidor intactos)');
    break;
  case 'nick':
    if (!args) { toast('Uso: /nick <nombre>'); return; }
    currentUser.name = args.slice(0, 32);
    updateProfile(auth.currentUser, { displayName: currentUser.name });
    setDoc(doc(db, 'users', currentUser.uid), { name: currentUser.name }, { merge: true });
    $('sb-name').textContent = currentUser.name;
    toast(`Nombre cambiado a: ${currentUser.name}`);
    break;
  case 'me':
    if (!args) return;
    addDoc(collection(db, 'channels', activeChannel, 'messages'), {
      type: 'action', content: `${currentUser.name} ${args}`,
      authorId: currentUser.uid, authorName: currentUser.name,
      authorAvatar: currentUser.avatar, ts: serverTimestamp(),
    });
    break;
  case 'shrug': sysPost('¯\\_(ツ)_/¯'); break;
  case 'flip':  sysPost('(╯°□°）╯︵ ┻━┻'); break;
  case 'whoami':
    sysPost(`${currentUser.name} · ${currentUser.email} · sesión activa`);
    break;
  default:
    toast(`Comando desconocido: /${cmd}`);
}
```

}

// ── IMAGE COMPRESSION ────────────────────
function compressImage(file, maxW, quality) {
return new Promise((resolve, reject) => {
const img = new Image();
const url = URL.createObjectURL(file);
img.onload = () => {
URL.revokeObjectURL(url);
const canvas = document.createElement(‘canvas’);
let w = img.width, h = img.height;
if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
canvas.width = w; canvas.height = h;
canvas.getContext(‘2d’).drawImage(img, 0, 0, w, h);
resolve(canvas.toDataURL(‘image/jpeg’, quality));
};
img.onerror = reject;
img.src = url;
});
}

// ── FILE HANDLING ─────────────────────────
function queueFile(file, type) {
if (type === ‘image’ && file.size > 5 * 1024 * 1024)  { toast(‘Imagen muy grande (máx 5 MB)’); return; }
if (type === ‘file’  && file.size > 1 * 1024 * 1024)  { toast(‘Archivo máx 1 MB en plan gratuito’); return; }
const reader = new FileReader();
reader.onload = e => {
pendingFiles.push({ file, type, data: e.target.result });
renderPending();
};
reader.readAsDataURL(file);
}

function renderPending() {
const area = $(‘att-preview’);
area.innerHTML = ‘’;
if (!pendingFiles.length) { area.classList.add(‘hidden’); return; }
area.classList.remove(‘hidden’);

```
pendingFiles.forEach((pf, i) => {
  const chip = document.createElement('div');
  chip.className = 'att-chip';

  if (pf.type === 'image') {
    const img = document.createElement('img');
    img.className = 'att-thumb';
    img.src = URL.createObjectURL(pf.file);
    chip.appendChild(img);
  } else {
    const tag = document.createElement('span');
    tag.className = 'att-tag';
    tag.textContent = fileTag(pf.file.name);
    chip.appendChild(tag);
  }

  const name = document.createElement('span');
  name.className = 'att-name';
  name.textContent = pf.file.name.length > 20 ? pf.file.name.slice(0,17)+'...' : pf.file.name;
  chip.appendChild(name);

  const rm = document.createElement('button');
  rm.className = 'att-rm';
  rm.textContent = '✕';
  rm.onclick = () => { pendingFiles.splice(i, 1); renderPending(); };
  chip.appendChild(rm);

  area.appendChild(chip);
});
```

}

function clearPending() {
pendingFiles = [];
renderPending();
}

// ── LIGHTBOX ─────────────────────────────
const openLightbox = (src, name) => {
$(‘lb-img’).src = src;
$(‘lb-meta’).textContent = name;
$(‘lightbox’).classList.remove(‘hidden’);
};
const closeLightbox = () => {
$(‘lightbox’).classList.add(‘hidden’);
$(‘lb-img’).src = ‘’;
};

// ── TYPING INDICATOR ─────────────────────
const resizeInput = () => {
const el = $(‘msg-inp’);
el.style.height = ‘auto’;
el.style.height = Math.min(el.scrollHeight, 120) + ‘px’;
};

// ── DOM EVENTS ────────────────────────────
document.addEventListener(‘DOMContentLoaded’, () => {

```
// Auth toggles
$('goto-register').onclick = () => {
  $('panel-login').classList.remove('active');
  $('panel-register').classList.add('active');
  $('reg-name').focus();
};
$('goto-login').onclick = () => {
  $('panel-register').classList.remove('active');
  $('panel-login').classList.add('active');
  $('login-email').focus();
};

// Avatar selector
$('avatar-grid').querySelectorAll('.av-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.av-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentAvatar = btn.dataset.av;
  };
});

// Auth buttons
$('btn-register').onclick = doRegister;
$('btn-login').onclick    = doLogin;
$('btn-logout').onclick   = () => { if (confirm('¿Salir?')) doLogout(); };

$('login-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
$('login-email').addEventListener('keydown', e => { if (e.key === 'Enter') $('login-pass').focus(); });
$('reg-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });

// Channel list
document.querySelectorAll('.sb-item[data-ch]').forEach(el => {
  el.onclick = () => switchChannel(el.dataset.ch);
});
$('btn-add-ch').onclick = () => {
  const n = prompt('Nombre del canal (minúsculas):');
  if (n) addChannel(n);
};

// Message input
$('msg-inp').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
$('msg-inp').addEventListener('input', resizeInput);
$('btn-send').onclick = send;

// File buttons
$('btn-img').onclick  = () => $('inp-img').click();
$('btn-file').onclick = () => $('inp-file').click();
$('inp-img').onchange  = e => { const f = e.target.files[0]; if (f) queueFile(f,'image'); e.target.value=''; };
$('inp-file').onchange = e => { const f = e.target.files[0]; if (f) queueFile(f,'file');  e.target.value=''; };

// Drag & drop
const msgsEl = $('messages');
msgsEl.addEventListener('dragover', e => { e.preventDefault(); msgsEl.style.outline = '1px dashed #333'; });
msgsEl.addEventListener('dragleave', () => { msgsEl.style.outline = ''; });
msgsEl.addEventListener('drop', e => {
  e.preventDefault(); msgsEl.style.outline = '';
  [...e.dataTransfer.files].forEach(f => queueFile(f, f.type.startsWith('image/') ? 'image' : 'file'));
});

// Paste image
document.addEventListener('paste', e => {
  if (!currentUser) return;
  [...(e.clipboardData?.items||[])].forEach(item => {
    if (item.type.startsWith('image/')) {
      const f = item.getAsFile();
      if (f) queueFile(f, 'image');
    }
  });
});

// Search
$('btn-search').onclick = () => {
  $('searchbar').classList.toggle('hidden');
  if (!$('searchbar').classList.contains('hidden')) $('search-inp').focus();
};
$('btn-s-close').onclick = () => { $('searchbar').classList.add('hidden'); $('search-inp').value = ''; };
$('search-inp').oninput = () => {
  const q = $('search-inp').value.toLowerCase();
  document.querySelectorAll('.msg').forEach(el => {
    el.style.display = (!q || el.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
};

// Commands overlay
$('btn-help').onclick       = () => $('overlay-cmds').classList.remove('hidden');
$('btn-close-cmds').onclick = () => $('overlay-cmds').classList.add('hidden');

// Lightbox
$('lb-close').onclick = closeLightbox;
$('lb-bg').onclick    = closeLightbox;

// ESC
document.addEventListener('keydown', e => {
  if (e.key !== 'Escape') return;
  closeLightbox();
  $('overlay-cmds').classList.add('hidden');
});

// Mobile menu
$('btn-menu')?.addEventListener('click', () => $('sidebar').classList.toggle('open'));
```

});
</script>

</body>
</html>