<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TERM â€” Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;background:#000;color:#fff;font-family:'IBM Plex Mono',monospace;font-size:13px}
.screen{display:none;height:100vh;width:100%}
.screen.active{display:flex}
#screen-auth{align-items:center;justify-content:center;background:#000}
.auth-wrap{width:340px;padding:0 16px}
.logo{font-size:28px;font-weight:600;letter-spacing:8px;margin-bottom:4px}
.logo-sub{font-size:10px;color:#555;letter-spacing:2px;margin-bottom:28px;padding-bottom:18px;border-bottom:1px solid #1e1e1e}
.auth-panel{display:none;flex-direction:column;gap:16px}
.auth-panel.active{display:flex}
.panel-label{font-size:9px;letter-spacing:3px;color:#555}
.field-group{display:flex;flex-direction:column;gap:5px}
.field-label{font-size:9px;letter-spacing:2px;color:#555}
.field-input{width:100%;background:#0d0d0d;border:1px solid #1e1e1e;border-bottom:1px solid #333;color:#fff;font-family:'IBM Plex Mono',monospace;font-size:13px;padding:10px 12px;outline:none}
.field-input:focus{border-bottom-color:#fff;background:#111}
.field-input::placeholder{color:#333}
.avatar-grid{display:flex;gap:6px;flex-wrap:wrap}
.av-btn{background:#111;border:1px solid #1e1e1e;color:#888;font-family:'IBM Plex Mono',monospace;font-size:11px;padding:6px 9px;cursor:pointer}
.av-btn.active{background:#fff;color:#000;border-color:#fff}
.btn-primary{background:#fff;border:1px solid #fff;color:#000;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;letter-spacing:3px;padding:12px;cursor:pointer;width:100%}
.btn-ghost{background:none;border:none;color:#555;font-family:'IBM Plex Mono',monospace;font-size:11px;padding:5px 0;cursor:pointer;text-align:left}
.auth-error{font-size:11px;color:#ccc;border-left:2px solid #fff;padding:6px 10px;background:#111;display:none}
.auth-footer{margin-top:28px;font-size:9px;letter-spacing:1.5px;color:#333;border-top:1px solid #1e1e1e;padding-top:14px}
#screen-chat{flex-direction:row;overflow:hidden}
#sidebar{width:220px;min-width:220px;height:100%;background:#0d0d0d;border-right:1px solid #1e1e1e;display:flex;flex-direction:column}
.sb-top{display:flex;align-items:center;justify-content:space-between;padding:13px 15px;border-bottom:1px solid #1e1e1e}
.brand{font-size:13px;font-weight:600;letter-spacing:5px}
.sb-user{display:flex;align-items:center;gap:9px;padding:12px 15px;border-bottom:1px solid #1e1e1e}
.sb-av{font-size:10px;background:#1a1a1a;border:1px solid #1e1e1e;padding:4px 5px;color:#fff}
.sb-name{font-size:12px;font-weight:600}
.sb-email{font-size:10px;color:#555;word-break:break-all}
.sb-section{padding:14px 0 6px;border-bottom:1px solid #1e1e1e}
.sb-label{font-size:9px;letter-spacing:3px;color:#333;padding:0 15px 8px}
.sb-list{list-style:none}
.sb-item{display:flex;align-items:center;gap:6px;padding:7px 15px;cursor:pointer;color:#555;font-size:12px;position:relative}
.sb-item.active{color:#fff;background:#1a1a1a}
.sb-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:#fff}
.ch-hash{color:#333;font-size:11px}
.sb-add{display:block;margin:8px 15px 2px;width:calc(100% - 30px);background:none;border:1px dashed #1e1e1e;color:#333;font-family:'IBM Plex Mono',monospace;font-size:11px;padding:6px 10px;cursor:pointer;text-align:left}
.sb-footer{margin-top:auto;padding:10px 15px;border-top:1px solid #1e1e1e}
.sb-stat{display:flex;justify-content:space-between;font-size:9px;margin-bottom:3px}
.icon-btn{background:none;border:none;color:#555;font-family:'IBM Plex Mono',monospace;font-size:15px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#000}
#topbar{height:44px;border-bottom:1px solid #1e1e1e;display:flex;align-items:center;padding:0 15px;gap:10px;background:#0d0d0d}
.tb-left{display:flex;align-items:baseline;gap:6px;flex:1}
.tb-hash{color:#333}
#tb-name{font-size:13px;font-weight:600}
.tb-sep{color:#333;font-size:11px}
.tb-desc{font-size:11px;color:#555}
#messages{flex:1;overflow-y:auto;padding:18px 0 6px;display:flex;flex-direction:column}
.day-sep{display:flex;align-items:center;gap:12px;padding:10px 20px;font-size:9px;letter-spacing:2px;color:#333}
.day-sep::before,.day-sep::after{content:'';flex:1;height:1px;background:#1a1a1a}
.msg{display:flex;gap:11px;padding:5px 20px;position:relative}
.msg:hover{background:#0d0d0d}
.msg-av{font-size:10px;color:#333;flex-shrink:0;width:34px;padding-top:3px;text-align:center}
.msg-body{flex:1;min-width:0}
.msg-meta{display:flex;align-items:baseline;gap:8px;margin-bottom:2px}
.msg-name{font-size:12px;font-weight:600;color:#fff}
.msg-time{font-size:9px;color:#333}
.msg-text{color:#ccc;font-size:13px;line-height:1.7;white-space:pre-wrap;word-break:break-word}
.msg.sys .msg-text{color:#333;font-style:italic;font-size:11px}
#typing-row{display:flex;align-items:center;gap:8px;padding:3px 20px 3px 65px;font-size:10px;color:#333}
.t-dots{display:flex;gap:3px}
.t-dots span{width:3px;height:3px;background:#333;border-radius:50%;animation:td 1.1s infinite}
.t-dots span:nth-child(2){animation-delay:.18s}
.t-dots span:nth-child(3){animation-delay:.36s}
@keyframes td{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-3px);opacity:1}}
#composer{border-top:1px solid #1e1e1e;padding:11px 15px;background:#0d0d0d}
#att-preview{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:9px}
.att-chip{display:flex;align-items:center;gap:6px;background:#1a1a1a;border:1px solid #1e1e1e;padding:4px 8px;font-size:11px;color:#888}
.att-thumb{width:34px;height:34px;object-fit:cover}
#composer-row{display:flex;align-items:flex-end;gap:8px;background:#111;border:1px solid #1e1e1e;padding:8px 10px}
.c-prompt{font-size:11px;color:#333;white-space:nowrap;flex-shrink:0}
#msg-inp{flex:1;background:none;border:none;color:#fff;font-family:'IBM Plex Mono',monospace;font-size:13px;outline:none;resize:none;max-height:120px;overflow-y:auto;line-height:1.65}
#msg-inp::placeholder{color:#333}
.c-tools{display:flex;align-items:flex-end;gap:4px}
.tool-btn{background:none;border:1px solid #1e1e1e;color:#555;font-family:'IBM Plex Mono',monospace;font-size:10px;padding:5px 8px;cursor:pointer}
.send-btn{background:#fff;border:1px solid #fff;color:#000;font-family:'IBM Plex Mono',monospace;font-size:15px;font-weight:700;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.c-hint{margin-top:6px;font-size:9px;color:#333}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:500;background:rgba(0,0,0,.8)}
.overlay-box{background:#0d0d0d;border:1px solid #2a2a2a;padding:22px;width:320px;max-width:calc(100vw - 32px)}
.ov-title{font-size:9px;letter-spacing:3px;color:#333;margin-bottom:16px}
.cmd-table{border-collapse:collapse;width:100%;margin-bottom:18px}
.cmd-table tr+tr td{padding-top:8px}
.ck{font-size:12px;color:#fff;padding-right:18px;white-space:nowrap}
.cv{font-size:11px;color:#555}
#lightbox{position:fixed;inset:0;z-index:600;display:flex;align-items:center;justify-content:center}
#lb-bg{position:absolute;inset:0;background:rgba(0,0,0,.92)}
#lb-inner{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:8px}
#lb-img{max-width:90vw;max-height:85vh;display:block}
#lb-close{position:absolute;top:-14px;right:-14px;background:#1a1a1a;border:1px solid #1e1e1e;color:#555;font-family:'IBM Plex Mono',monospace;font-size:12px;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
#toast{position:fixed;bottom:18px;right:18px;background:#fff;color:#000;font-family:'IBM Plex Mono',monospace;font-size:11px;padding:9px 14px;z-index:700;display:none}
.hidden{display:none!important}
.mobile-only{display:none}
@media(max-width:680px){
.mobile-only{display:flex}
#sidebar{position:fixed;left:0;top:0;bottom:0;z-index:300;transform:translateX(-100%);transition:transform .25s}
#sidebar.open{transform:translateX(0)}
.auth-wrap{width:calc(100vw - 32px)}
}
</style>
</head>
<body>

<div id="screen-auth" class="screen active">
  <div class="auth-wrap">
    <div class="logo">TERM</div>
    <div class="logo-sub">// INTERNAL MESSENGER</div>

```
<div class="auth-panel active" id="panel-login">
  <div class="panel-label">INICIAR SESION</div>
  <div class="field-group">
    <label class="field-label">EMAIL</label>
    <input id="login-email" type="email" class="field-input" placeholder="tu@email.com"/>
  </div>
  <div class="field-group">
    <label class="field-label">CONTRASENA</label>
    <input id="login-pass" type="password" class="field-input" placeholder="min. 6 caracteres"/>
  </div>
  <button class="btn-primary" onclick="doLogin()">CONECTAR</button>
  <button class="btn-ghost" onclick="showPanel('register')">Sin cuenta - Registrarse</button>
  <div class="auth-error" id="login-error"></div>
</div>

<div class="auth-panel" id="panel-register">
  <div class="panel-label">CREAR CUENTA</div>
  <div class="field-group">
    <label class="field-label">NOMBRE</label>
    <input id="reg-name" type="text" class="field-input" placeholder="Tu Nombre" maxlength="32"/>
  </div>
  <div class="field-group">
    <label class="field-label">EMAIL</label>
    <input id="reg-email" type="email" class="field-input" placeholder="tu@email.com"/>
  </div>
  <div class="field-group">
    <label class="field-label">CONTRASENA</label>
    <input id="reg-pass" type="password" class="field-input" placeholder="min. 6 caracteres"/>
  </div>
  <div class="field-group">
    <label class="field-label">AVATAR</label>
    <div class="avatar-grid" id="avatar-grid">
      <button class="av-btn active" onclick="selectAvatar(this,'[ ]')">[ ]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[+]')">[+]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[~]')">[~]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[#]')">[#]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[$]')">[$]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[*]')">[*]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[!]')">[!]</button>
      <button class="av-btn" onclick="selectAvatar(this,'[?]')">[?]</button>
    </div>
  </div>
  <button class="btn-primary" onclick="doRegister()">CREAR</button>
  <button class="btn-ghost" onclick="showPanel('login')">Ya tengo cuenta - Entrar</button>
  <div class="auth-error" id="reg-error"></div>
</div>

<div class="auth-footer">CIFRADO - TIEMPO REAL - USO INTERNO</div>
```

  </div>
</div>

<div id="screen-chat" class="screen">
  <nav id="sidebar">
    <div class="sb-top">
      <div class="brand">TERM</div>
      <button class="icon-btn" onclick="doLogout()">off</button>
    </div>
    <div class="sb-user">
      <div class="sb-av" id="sb-av">[ ]</div>
      <div>
        <div class="sb-name" id="sb-name">-</div>
        <div class="sb-email" id="sb-email">-</div>
      </div>
    </div>
    <div class="sb-section">
      <div class="sb-label">CANALES</div>
      <ul class="sb-list" id="channel-list">
        <li class="sb-item active" data-ch="general" onclick="switchChannel('general')"><span class="ch-hash">#</span>general</li>
        <li class="sb-item" data-ch="archivos" onclick="switchChannel('archivos')"><span class="ch-hash">#</span>archivos</li>
        <li class="sb-item" data-ch="ops" onclick="switchChannel('ops')"><span class="ch-hash">#</span>ops</li>
      </ul>
      <button class="sb-add" onclick="addChannelPrompt()">+ canal</button>
    </div>
    <div class="sb-section">
      <div class="sb-label">EN LINEA</div>
      <ul class="sb-list" id="online-list"></ul>
    </div>
    <div class="sb-footer">
      <div class="sb-stat"><span style="color:#333">ESTADO</span><span id="stat-conn" style="color:#888">-</span></div>
      <div class="sb-stat"><span style="color:#333">CANAL</span><span id="stat-ch" style="color:#888">general</span></div>
    </div>
  </nav>

  <main id="main">
    <div id="topbar">
      <button class="icon-btn mobile-only" onclick="document.getElementById('sidebar').classList.toggle('open')">=</button>
      <div class="tb-left">
        <span class="tb-hash">#</span>
        <span id="tb-name">general</span>
        <span class="tb-sep">-</span>
        <span class="tb-desc" id="tb-desc">chat general</span>
      </div>
      <div style="display:flex;gap:2px">
        <button class="icon-btn" onclick="toggleSearch()">buscar</button>
        <button class="icon-btn" onclick="document.getElementById('overlay-cmds').classList.remove('hidden')">/</button>
      </div>
    </div>

```
<div id="searchbar" class="hidden" style="display:flex;align-items:center;gap:10px;padding:7px 15px;border-bottom:1px solid #1e1e1e;background:#111">
  <span style="font-size:11px;color:#333">buscar</span>
  <input id="search-inp" type="text" placeholder="filtrar..." style="flex:1;background:none;border:none;color:#fff;font-family:'IBM Plex Mono',monospace;font-size:13px;outline:none" oninput="filterMessages()"/>
  <button class="icon-btn" onclick="closeSearch()">x</button>
</div>

<div id="messages" role="log"></div>

<div id="typing-row" class="hidden">
  <div class="t-dots"><span></span><span></span><span></span></div>
  <span id="typing-who">escribiendo...</span>
</div>

<div id="composer">
  <div id="att-preview" class="hidden"></div>
  <div id="composer-row">
    <div class="c-prompt" id="c-prompt">&gt; </div>
    <textarea id="msg-inp" rows="1" placeholder="escribe un mensaje..." oninput="resizeInput()" onkeydown="handleKey(event)"></textarea>
    <div class="c-tools">
      <button class="tool-btn" onclick="document.getElementById('inp-img').click()">img</button>
      <button class="tool-btn" onclick="document.getElementById('inp-file').click()">archivo</button>
      <button class="send-btn" onclick="sendMessage()">send</button>
    </div>
  </div>
  <div class="c-hint">Enter enviar - Shift+Enter nueva linea</div>
</div>
<input type="file" id="inp-img" accept="image/*" style="display:none" onchange="handleImageFile(this)"/>
<input type="file" id="inp-file" style="display:none" onchange="handleAnyFile(this)"/>
```

  </main>

  <div id="overlay-cmds" class="overlay hidden">
    <div class="overlay-box">
      <div class="ov-title">// COMANDOS</div>
      <table class="cmd-table">
        <tr><td class="ck">/help</td><td class="cv">comandos</td></tr>
        <tr><td class="ck">/nick n</td><td class="cv">cambiar nombre</td></tr>
        <tr><td class="ck">/me texto</td><td class="cv">accion</td></tr>
        <tr><td class="ck">/clear</td><td class="cv">limpiar vista</td></tr>
        <tr><td class="ck">/shrug</td><td class="cv">shrug</td></tr>
      </table>
      <button class="btn-ghost" onclick="document.getElementById('overlay-cmds').classList.add('hidden')">[ cerrar ]</button>
    </div>
  </div>

  <div id="lightbox" class="hidden">
    <div id="lb-bg" onclick="closeLightbox()"></div>
    <div id="lb-inner">
      <button id="lb-close" onclick="closeLightbox()">x</button>
      <img id="lb-img" src="" alt=""/>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- Firebase compat (NO module) -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// CONFIG
firebase.initializeApp({
  apiKey: "AIzaSyCsnaUlAym1xBy0QnlBehRvm1o8cthOVoI",
  authDomain: "terminalmessenger-6040b.firebaseapp.com",
  projectId: "terminalmessenger-6040b",
  storageBucket: "terminalmessenger-6040b.firebasestorage.app",
  messagingSenderId: "932577335300",
  appId: "1:932577335300:web:cb0e53f8ee72f323e4bd51"
});

const auth = firebase.auth();
const db = firebase.firestore();

// STATE
let currentUser = null;
let currentAvatar = '[ ]';
let activeChannel = 'general';
let unsubMessages = null;
let pendingFiles = [];

const CHANNELS = {
  general: 'chat general',
  archivos: 'archivos y transferencias',
  ops: 'operaciones internas'
};

// UTILS
const $ = id => document.getElementById(id);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function ftime(ts) {
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function fsize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(2) + ' MB';
}

function fileTag(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  const m = {pdf:'PDF',doc:'DOC',docx:'DOC',txt:'TXT',xls:'XLS',xlsx:'XLS',
    zip:'ZIP',mp3:'MP3',mp4:'MP4',js:'JS',py:'PY',html:'HTM',json:'JSON'};
  return m[ext] || 'FILE';
}

let toastT;
function toast(msg) {
  const el = $('toast');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(toastT);
  toastT = setTimeout(() => el.style.display = 'none', 3000);
}

function showErr(id, msg) {
  const el = $(id);
  el.textContent = msg;
  el.style.display = 'block';
}

// AUTH UI
function showPanel(name) {
  $('panel-login').classList.toggle('active', name === 'login');
  $('panel-register').classList.toggle('active', name === 'register');
}

function selectAvatar(btn, av) {
  document.querySelectorAll('.av-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentAvatar = av;
}

// REGISTER
function doRegister() {
  const name = $('reg-name').value.trim();
  const email = $('reg-email').value.trim();
  const pass = $('reg-pass').value;
  $('reg-error').style.display = 'none';

  if (!name) { showErr('reg-error', 'Ingresa tu nombre'); return; }
  if (!email) { showErr('reg-error', 'Ingresa tu email'); return; }
  if (pass.length < 6) { showErr('reg-error', 'Contrasena minimo 6 caracteres'); return; }

  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return cred.user.updateProfile({displayName: name}).then(() => {
        return db.collection('users').doc(cred.user.uid).set({
          name, email, avatar: currentAvatar,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    })
    .catch(e => showErr('reg-error', firebaseErr(e.code)));
}

// LOGIN
function doLogin() {
  const email = $('login-email').value.trim();
  const pass = $('login-pass').value;
  $('login-error').style.display = 'none';

  if (!email || !pass) { showErr('login-error', 'Completa todos los campos'); return; }

  auth.signInWithEmailAndPassword(email, pass)
    .catch(e => showErr('login-error', firebaseErr(e.code)));
}

// LOGOUT
function doLogout() {
  if (!confirm('Salir?')) return;
  setOnline(false);
  auth.signOut();
}

function firebaseErr(code) {
  const m = {
    'auth/email-already-in-use': 'Email ya registrado',
    'auth/invalid-email': 'Email invalido',
    'auth/weak-password': 'Contrasena muy debil',
    'auth/user-not-found': 'Usuario no encontrado',
    'auth/wrong-password': 'Contrasena incorrecta',
    'auth/invalid-credential': 'Email o contrasena incorrectos',
    'auth/network-request-failed': 'Sin conexion'
  };
  return m[code] || 'Error: ' + code;
}

// AUTH STATE
auth.onAuthStateChanged(user => {
  if (user) {
    db.collection('users').doc(user.uid).get().then(snap => {
      const data = snap.exists ? snap.data() : {};
      currentUser = {
        uid: user.uid,
        name: user.displayName || 'Usuario',
        email: user.email,
        avatar: data.avatar || '[ ]'
      };
      bootChat();
    });
  } else {
    currentUser = null;
    $('screen-auth').classList.add('active');
    $('screen-chat').classList.remove('active');
  }
});

// PRESENCE
function setOnline(online) {
  if (!currentUser) return;
  db.collection('presence').doc(currentUser.uid).set({
    name: currentUser.name,
    avatar: currentUser.avatar,
    online,
    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge: true});
}

function listenOnline() {
  db.collection('presence').where('online','==',true).onSnapshot(snap => {
    const list = $('online-list');
    list.innerHTML = '';
    snap.forEach(d => {
      const u = d.data();
      const li = document.createElement('li');
      li.className = 'sb-item';
      li.style.cursor = 'default';
      li.innerHTML = '<span class="ch-hash">' + esc(u.avatar||'[ ]') + '</span>' + esc(u.name);
      list.appendChild(li);
    });
  });
}

// BOOT
function bootChat() {
  $('screen-auth').classList.remove('active');
  $('screen-chat').classList.add('active');
  $('sb-av').textContent = currentUser.avatar;
  $('sb-name').textContent = currentUser.name;
  $('sb-email').textContent = currentUser.email;
  $('stat-conn').textContent = 'EN LINEA';
  $('c-prompt').textContent = '@' + currentUser.name.split(' ')[0].toLowerCase() + ' > ';
  setOnline(true);
  listenOnline();
  switchChannel('general');
  setInterval(() => setOnline(true), 60000);
  window.addEventListener('beforeunload', () => setOnline(false));
}

// CHANNELS
function switchChannel(ch) {
  activeChannel = ch;
  document.querySelectorAll('.sb-item[data-ch]').forEach(el => {
    el.classList.toggle('active', el.dataset.ch === ch);
  });
  $('tb-name').textContent = ch;
  $('tb-desc').textContent = CHANNELS[ch] || 'canal personalizado';
  $('stat-ch').textContent = ch;
  $('messages').innerHTML = '';
  listenMessages(ch);
  $('sidebar').classList.remove('open');
}

function addChannelPrompt() {
  const name = prompt('Nombre del canal:');
  if (!name) return;
  const clean = name.toLowerCase().replace(/[^a-z0-9_-]/g,'').slice(0,20);
  if (clean.length < 2) { toast('Nombre invalido'); return; }
  CHANNELS[clean] = 'canal personalizado';
  const li = document.createElement('li');
  li.className = 'sb-item';
  li.dataset.ch = clean;
  li.setAttribute('onclick', "switchChannel('" + clean + "')");
  li.innerHTML = '<span class="ch-hash">#</span>' + clean;
  $('channel-list').appendChild(li);
  switchChannel(clean);
}

// MESSAGES
let lastDate = null;
let initialized = false;

function listenMessages(channel) {
  if (unsubMessages) unsubMessages();
  lastDate = null;
  initialized = false;

  const q = db.collection('channels').doc(channel).collection('messages')
    .orderBy('ts','asc').limitToLast(200);

  unsubMessages = q.onSnapshot(snap => {
    snap.docChanges().forEach(change => {
      if (change.type === 'added') {
        const msg = {id: change.doc.id, ...change.doc.data()};
        appendMsg(msg, initialized);
      }
    });
    if (!initialized) {
      initialized = true;
      scrollBottom();
    }
  });
}

function appendMsg(msg, animate) {
  const list = $('messages');

  // Day separator
  const ts = msg.ts ? (msg.ts.toDate ? msg.ts.toDate() : new Date(msg.ts)) : new Date();
  const dateStr = ts.toLocaleDateString('es', {weekday:'short', month:'short', day:'numeric'}).toUpperCase();
  if (dateStr !== lastDate) {
    const sep = document.createElement('div');
    sep.className = 'day-sep';
    sep.textContent = dateStr;
    list.appendChild(sep);
    lastDate = dateStr;
  }

  const div = document.createElement('div');
  const isOwn = msg.authorId === currentUser.uid;

  if (msg.type === 'sys') {
    div.className = 'msg sys';
    div.innerHTML = '<div class="msg-av">-</div><div class="msg-body"><div class="msg-text">' + esc(msg.content) + '</div></div>';
    list.appendChild(div);
    if (animate) scrollBottom();
    return;
  }

  div.className = 'msg' + (isOwn ? ' own' : '');
  div.dataset.id = msg.id;

  const av = document.createElement('div');
  av.className = 'msg-av';
  av.textContent = msg.authorAvatar || '[ ]';

  const body = document.createElement('div');
  body.className = 'msg-body';
  body.innerHTML = '<div class="msg-meta"><span class="msg-name">' + esc(msg.authorName||'?') + '</span><span class="msg-time">' + ftime(msg.ts) + '</span></div>';

  const txt = document.createElement('div');
  txt.className = 'msg-text';
  if (msg.content) txt.textContent = msg.content;

  if (msg.imageUrl) {
    const img = document.createElement('img');
    img.src = msg.imageUrl;
    img.style.cssText = 'display:block;max-width:260px;max-height:200px;margin-top:8px;cursor:pointer;border:1px solid #1e1e1e';
    img.onclick = () => { $('lb-img').src = msg.imageUrl; $('lightbox').classList.remove('hidden'); };
    txt.appendChild(img);
  }

  if (msg.fileData) {
    const f = document.createElement('div');
    f.style.cssText = 'display:inline-flex;align-items:center;gap:10px;margin-top:8px;padding:10px 14px;background:#111;border:1px solid #1e1e1e;cursor:pointer';
    f.innerHTML = '<span style="color:#555;font-size:10px">' + fileTag(msg.fileName||'') + '</span><span><span style="display:block;font-size:12px;color:#fff">' + esc(msg.fileName||'archivo') + '</span><span style="display:block;font-size:10px;color:#555">' + (msg.fileSize||'') + '</span></span>';
    f.onclick = () => { const a = document.createElement('a'); a.href = msg.fileData; a.download = msg.fileName||'archivo'; a.click(); };
    txt.appendChild(f);
  }

  body.appendChild(txt);
  div.appendChild(av);
  div.appendChild(body);
  list.appendChild(div);
  if (animate) scrollBottom();
}

function scrollBottom() {
  const el = $('messages');
  el.scrollTop = el.scrollHeight;
}

// SEND
function sendMessage() {
  const input = $('msg-inp');
  const text = input.value.trim();
  if (!text && pendingFiles.length === 0) return;

  if (text.startsWith('/')) {
    input.value = '';
    resizeInput();
    handleCommand(text);
    return;
  }

  const base = {
    authorId: currentUser.uid,
    authorName: currentUser.name,
    authorAvatar: currentUser.avatar,
    ts: firebase.firestore.FieldValue.serverTimestamp(),
    type: 'text',
    content: text
  };

  input.value = '';
  resizeInput();

  if (pendingFiles.length > 0) {
    pendingFiles.forEach((pf, i) => {
      const msgData = Object.assign({}, base, {content: i === 0 ? text : ''});
      if (pf.type === 'image') {
        compressImage(pf.file, 800, 0.7).then(data64 => {
          msgData.imageUrl = data64;
          msgData.imageName = pf.file.name;
          db.collection('channels').doc(activeChannel).collection('messages').add(msgData);
        });
      } else {
        const reader = new FileReader();
        reader.onload = e => {
          msgData.fileData = e.target.result;
          msgData.fileName = pf.file.name;
          msgData.fileSize = fsize(pf.file.size);
          db.collection('channels').doc(activeChannel).collection('messages').add(msgData);
        };
        reader.readAsDataURL(pf.file);
      }
    });
    clearPending();
  } else {
    db.collection('channels').doc(activeChannel).collection('messages').add(base);
  }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

// COMMANDS
function handleCommand(raw) {
  const parts = raw.slice(1).split(' ');
  const cmd = parts[0].toLowerCase();
  const args = parts.slice(1).join(' ').trim();

  const sys = content => db.collection('channels').doc(activeChannel).collection('messages').add({
    type:'sys', content, authorId: currentUser.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });

  switch(cmd) {
    case 'help': $('overlay-cmds').classList.remove('hidden'); break;
    case 'clear': $('messages').innerHTML = ''; toast('Vista limpiada'); break;
    case 'nick':
      if (!args) { toast('Uso: /nick nombre'); return; }
      currentUser.name = args.slice(0,32);
      auth.currentUser.updateProfile({displayName: currentUser.name});
      db.collection('users').doc(currentUser.uid).set({name: currentUser.name},{merge:true});
      $('sb-name').textContent = currentUser.name;
      toast('Nombre: ' + currentUser.name);
      break;
    case 'me': if (args) sys(currentUser.name + ' ' + args); break;
    case 'shrug': sys('shrug'); break;
    default: toast('Comando desconocido: /' + cmd);
  }
}

// FILES
function compressImage(file, maxW, quality) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = reject;
    img.src = url;
  });
}

function handleImageFile(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { toast('Imagen max 5MB'); return; }
  pendingFiles.push({file, type:'image'});
  renderPending();
  input.value = '';
}

function handleAnyFile(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 1*1024*1024) { toast('Archivo max 1MB'); return; }
  if (file.type.startsWith('image/')) {
    pendingFiles.push({file, type:'image'});
  } else {
    pendingFiles.push({file, type:'file'});
  }
  renderPending();
  input.value = '';
}

function renderPending() {
  const area = $('att-preview');
  area.innerHTML = '';
  if (!pendingFiles.length) { area.classList.add('hidden'); return; }
  area.classList.remove('hidden');
  pendingFiles.forEach((pf, i) => {
    const chip = document.createElement('div');
    chip.className = 'att-chip';
    if (pf.type === 'image') {
      const img = document.createElement('img');
      img.className = 'att-thumb';
      img.src = URL.createObjectURL(pf.file);
      chip.appendChild(img);
    }
    const name = document.createElement('span');
    name.textContent = pf.file.name.slice(0,20);
    chip.appendChild(name);
    const rm = document.createElement('button');
    rm.style.cssText = 'background:none;border:none;color:#555;cursor:pointer;font-size:11px';
    rm.textContent = 'x';
    rm.onclick = () => { pendingFiles.splice(i,1); renderPending(); };
    chip.appendChild(rm);
    area.appendChild(chip);
  });
}

function clearPending() {
  pendingFiles = [];
  renderPending();
}

// LIGHTBOX
function closeLightbox() {
  $('lightbox').classList.add('hidden');
  $('lb-img').src = '';
}

// SEARCH
function toggleSearch() {
  $('searchbar').classList.toggle('hidden');
  if (!$('searchbar').classList.contains('hidden')) $('search-inp').focus();
}

function closeSearch() {
  $('searchbar').classList.add('hidden');
  $('search-inp').value = '';
  filterMessages();
}

function filterMessages() {
  const q = $('search-inp').value.toLowerCase();
  document.querySelectorAll('.msg').forEach(el => {
    el.style.display = (!q || el.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
}

// INPUT
function resizeInput() {
  const el = $('msg-inp');
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// DRAG & DROP
document.addEventListener('DOMContentLoaded', () => {
  const msgs = $('messages');
  msgs.addEventListener('dragover', e => { e.preventDefault(); msgs.style.outline = '1px dashed #333'; });
  msgs.addEventListener('dragleave', () => msgs.style.outline = '');
  msgs.addEventListener('drop', e => {
    e.preventDefault(); msgs.style.outline = '';
    [...e.dataTransfer.files].forEach(f => {
      if (f.type.startsWith('image/')) {
        pendingFiles.push({file:f, type:'image'});
      } else {
        pendingFiles.push({file:f, type:'file'});
      }
      renderPending();
    });
  });

  document.addEventListener('paste', e => {
    if (!currentUser) return;
    [...(e.clipboardData?.items||[])].forEach(item => {
      if (item.type.startsWith('image/')) {
        const f = item.getAsFile();
        if (f) { pendingFiles.push({file:f,type:'image'}); renderPending(); }
      }
    });
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeLightbox();
      $('overlay-cmds').classList.add('hidden');
    }
  });
});
</script>

</body>
</html>